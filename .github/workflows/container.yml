name: Build + Deploy (Staging)

on:
  push:
    branches:
      - master
    tags:
      - "v*"

permissions:
  contents: read
  packages: write
  id-token: write

env:
  AWS_REGION: us-west-2
  IMAGE_NAME: calibratehealth
  GHCR_IMAGE: ghcr.io/${{ github.repository_owner }}/calibratehealth

jobs:
  build_and_push:
    name: Build and Push Image (GHCR + ECR)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure AWS credentials (ECR push)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_BUILD }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Compute tags
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          ECR_IMAGE="${{ steps.ecr.outputs.registry }}/${IMAGE_NAME}"
          # Docker image refs require lowercase repository names (GH owner can be mixed-case).
          GHCR_IMAGE="${GHCR_IMAGE,,}"

          TAGS=()
          TAGS+=("${GHCR_IMAGE}:sha-${GITHUB_SHA}")
          TAGS+=("${ECR_IMAGE}:sha-${GITHUB_SHA}")

          if [[ "${GITHUB_REF}" == "refs/heads/master" ]]; then
            # Tag a human-friendly branch alias for convenience.
            TAGS+=("${GHCR_IMAGE}:${GITHUB_REF_NAME}")
            TAGS+=("${ECR_IMAGE}:staging")
          fi

          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            TAGS+=("${GHCR_IMAGE}:${GITHUB_REF_NAME}")
          fi

          {
            echo "ecr_image=${ECR_IMAGE}"
            echo "ghcr_image=${GHCR_IMAGE}"
            echo "tags<<EOF"
            printf "%s\n" "${TAGS[@]}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Build and push (multi-arch)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.app
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}

  deploy_staging:
    name: Deploy Staging (ECS)
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: build_and_push
    if: github.ref == 'refs/heads/master'

    steps:
      - name: Configure AWS credentials (staging deploy)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEPLOY_STAGING }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Force new deployment (ECS)
        shell: bash
        run: |
          set -euo pipefail

          ENVIRONMENT="staging"
          ECS_CLUSTER="${IMAGE_NAME}-${ENVIRONMENT}-cluster"
          ECS_SERVICE="${IMAGE_NAME}-${ENVIRONMENT}-service"

          aws ecs update-service \
            --cluster "${ECS_CLUSTER}" \
            --service "${ECS_SERVICE}" \
            --force-new-deployment \
            >/dev/null

          wait_for_stable() {
            # awscli's `ecs wait services-stable` hard-codes a 10-minute deadline (40x15s).
            # ECS deployments can take longer (cold starts, image pulls, migrations, etc.), so
            # retry once before failing the workflow.
            local attempt
            for attempt in 1 2; do
              if aws ecs wait services-stable --cluster "${ECS_CLUSTER}" --services "${ECS_SERVICE}"; then
                return 0
              fi

              echo "Timed out waiting for ECS to become stable (attempt ${attempt}/2). Recent service events:" >&2
              aws ecs describe-services \
                --cluster "${ECS_CLUSTER}" \
                --services "${ECS_SERVICE}" \
                --query 'services[0].events[0:10].[createdAt,message]' \
                --output table \
                || true
            done

            return 1
          }

          wait_for_stable
