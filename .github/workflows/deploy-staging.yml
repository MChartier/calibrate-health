name: Deploy Staging

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: us-west-2
  IMAGE_NAME: calibratehealth

jobs:
  deploy:
    name: Deploy Staging (ECS)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Configure AWS credentials (staging deploy)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEPLOY_STAGING }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Force new deployment (ECS)
        shell: bash
        run: |
          set -euo pipefail

          ENVIRONMENT="staging"
          ECS_CLUSTER="${IMAGE_NAME}-${ENVIRONMENT}-cluster"
          ECS_SERVICE="${IMAGE_NAME}-${ENVIRONMENT}-service"

          aws ecs update-service \
            --cluster "${ECS_CLUSTER}" \
            --service "${ECS_SERVICE}" \
            --force-new-deployment \
            >/dev/null

          aws ecs wait services-stable --cluster "${ECS_CLUSTER}" --services "${ECS_SERVICE}"
