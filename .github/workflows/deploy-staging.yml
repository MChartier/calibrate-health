name: Deploy Staging

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: us-west-2
  IMAGE_NAME: calibratehealth

jobs:
  deploy:
    name: Deploy Staging (ECS)
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Configure AWS credentials (staging deploy)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEPLOY_STAGING }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Force new deployment (ECS)
        shell: bash
        run: |
          set -euo pipefail

          ENVIRONMENT="staging"
          ECS_CLUSTER="${IMAGE_NAME}-${ENVIRONMENT}-cluster"
          ECS_SERVICE="${IMAGE_NAME}-${ENVIRONMENT}-service"

          aws ecs update-service \
            --cluster "${ECS_CLUSTER}" \
            --service "${ECS_SERVICE}" \
            --force-new-deployment \
            >/dev/null

          wait_for_stable() {
            # awscli's `ecs wait services-stable` hard-codes a 10-minute deadline (40x15s).
            # ECS deployments can take longer (cold starts, image pulls, migrations, etc.), so
            # retry once before failing the workflow.
            local attempt
            for attempt in 1 2; do
              if aws ecs wait services-stable --cluster "${ECS_CLUSTER}" --services "${ECS_SERVICE}"; then
                return 0
              fi

              echo "Timed out waiting for ECS to become stable (attempt ${attempt}/2). Recent service events:" >&2
              aws ecs describe-services \
                --cluster "${ECS_CLUSTER}" \
                --services "${ECS_SERVICE}" \
                --query 'services[0].events[0:10].[createdAt,message]' \
                --output table \
                || true
            done

            return 1
          }

          wait_for_stable
